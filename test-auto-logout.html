<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë™ ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .status-indicator { padding: 10px; border-radius: 5px; margin: 10px 0; font-weight: bold; }
        .status-logged-in { background-color: #d4edda; color: #155724; }
        .status-logged-out { background-color: #f8d7da; color: #721c24; }
        .timer { font-size: 1.2em; font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ ìë™ ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h3>
            <ol>
                <li>ë¡œê·¸ì¸í•˜ì—¬ í† í° ë°œê¸‰</li>
                <li>í† í° ìƒíƒœ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</li>
                <li>í† í° ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜</li>
                <li>ìë™ ë¡œê·¸ì•„ì›ƒ í™•ì¸</li>
                <li>ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ë¡œ localStorage ë³€í™” ê´€ì°°</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ” 1. ë¡œê·¸ì¸</h3>
            <input type="email" id="email" placeholder="ì´ë©”ì¼" value="test2@example.com">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="password123">
            <button class="btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š 2. í˜„ì¬ ìƒíƒœ</h3>
            <div id="currentStatus" class="status-indicator status-logged-out">
                âŒ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
            </div>
            <button class="btn-info" onclick="checkStatus()">ìƒíƒœ í™•ì¸</button>
            <button class="btn-warning" onclick="showTokens()">í† í° ì •ë³´ ë³´ê¸°</button>
        </div>

        <div class="test-section">
            <h3>â° 3. í† í° ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜</h3>
            <button class="btn-warning" onclick="simulateTokenExpiry()">Access Token ì œê±°</button>
            <button class="btn-danger" onclick="simulateRefreshTokenExpiry()">Refresh Token ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜</button>
            <div id="expiryResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ 4. ìë™ ê°±ì‹  í…ŒìŠ¤íŠ¸</h3>
            <button class="btn-success" onclick="testAutoRefresh()">ìë™ ê°±ì‹  í…ŒìŠ¤íŠ¸</button>
            <div id="autoRefreshResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ§¹ 5. ìˆ˜ë™ ì •ë¦¬</h3>
            <button class="btn-danger" onclick="manualLogout()">ìˆ˜ë™ ë¡œê·¸ì•„ì›ƒ</button>
            <button class="btn-warning" onclick="clearAllData()">ëª¨ë“  ë°ì´í„° ì •ë¦¬</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ 6. ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div id="testLog" class="log"></div>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>

        <div class="test-section">
            <h3>â±ï¸ 7. ìë™ ìƒíƒœ í™•ì¸ íƒ€ì´ë¨¸</h3>
            <div class="timer" id="timer">00:00</div>
            <button class="btn-success" onclick="startAutoCheck()">ìë™ í™•ì¸ ì‹œì‘</button>
            <button class="btn-warning" onclick="stopAutoCheck()">ìë™ í™•ì¸ ì¤‘ì§€</button>
            <p>5ì´ˆë§ˆë‹¤ í† í° ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        let currentAccessToken = null;
        let autoCheckInterval = null;
        let startTime = Date.now();

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('testLog');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'blue';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStatusDisplay() {
            const statusDiv = document.getElementById('currentStatus');
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                statusDiv.className = 'status-indicator status-logged-in';
                statusDiv.innerHTML = 'âœ… ë¡œê·¸ì¸ ìƒíƒœ';
            } else {
                statusDiv.className = 'status-indicator status-logged-out';
                statusDiv.innerHTML = 'âŒ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ';
            }
        }

        // ë¡œê·¸ì¸
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                log('ğŸ” ë¡œê·¸ì¸ ì‹œë„...');
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    currentAccessToken = data.data.accessToken;
                    localStorage.setItem('accessToken', currentAccessToken);
                    localStorage.setItem('user', JSON.stringify(data.data.user));
                    
                    document.getElementById('loginResult').innerHTML = `
                        <div class="success">
                            âœ… ë¡œê·¸ì¸ ì„±ê³µ!<br>
                            ì‚¬ìš©ì: ${data.data.user.name}<br>
                            Access Token: ${currentAccessToken.substring(0, 50)}...<br>
                            Refresh Token: ì¿ í‚¤ì— ì„¤ì •ë¨
                        </div>
                    `;
                    log('âœ… ë¡œê·¸ì¸ ì„±ê³µ', 'success');
                    updateStatusDisplay();
                } else {
                    document.getElementById('loginResult').innerHTML = `
                        <div class="error">
                            âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${data.message}
                        </div>
                    `;
                    log(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${data.message}`, 'error');
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = `
                    <div class="error">
                        âŒ ì˜¤ë¥˜: ${error.message}
                    </div>
                `;
                log(`âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ìƒíƒœ í™•ì¸
        function checkStatus() {
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                const userData = JSON.parse(user);
                log(`âœ… í† í° ì¡´ì¬ - ì‚¬ìš©ì: ${userData.name}`, 'success');
            } else {
                log('âŒ í† í°ì´ ì—†ìŒ', 'error');
            }
            updateStatusDisplay();
        }

        // í† í° ì •ë³´ ë³´ê¸°
        function showTokens() {
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                const userData = JSON.parse(user);
                log(`ğŸ”‘ Access Token: ${token.substring(0, 50)}...`, 'info');
                log(`ğŸ‘¤ ì‚¬ìš©ì: ${userData.name} (${userData.email})`, 'info');
                log(`ğŸ“… ìƒì„± ì‹œê°„: ${new Date().toLocaleString()}`, 'info');
            } else {
                log('âŒ ì €ì¥ëœ í† í° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        // í† í° ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜
        function simulateTokenExpiry() {
            localStorage.removeItem('accessToken');
            currentAccessToken = null;
            
            document.getElementById('expiryResult').innerHTML = `
                <div class="warning">
                    âš ï¸ Access Tokenì„ ì œê±°í–ˆìŠµë‹ˆë‹¤ (ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜)<br>
                    ì´ì œ ë³´í˜¸ëœ APIë¥¼ í˜¸ì¶œí•˜ë©´ 401 ì—ëŸ¬ê°€ ë°œìƒí•´ì•¼ í•©ë‹ˆë‹¤.
                </div>
            `;
            log('âš ï¸ Access Token ì œê±°ë¨ (ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜)', 'warning');
            updateStatusDisplay();
        }

        // Refresh Token ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜
        function simulateRefreshTokenExpiry() {
            // ì¿ í‚¤ë¥¼ ì§ì ‘ ì‚­ì œí•  ìˆ˜ëŠ” ì—†ì§€ë§Œ, ë§Œë£Œëœ ê²ƒì²˜ëŸ¼ ì‹œë®¬ë ˆì´ì…˜
            log('âš ï¸ Refresh Token ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜ (ì¿ í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì•¼ í•¨)', 'warning');
            document.getElementById('expiryResult').innerHTML = `
                <div class="warning">
                    âš ï¸ Refresh Token ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜<br>
                    ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ â†’ Application â†’ Cookiesì—ì„œ refreshTokenì„ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•˜ì„¸ìš”.
                </div>
            `;
        }

        // ìë™ ê°±ì‹  í…ŒìŠ¤íŠ¸
        async function testAutoRefresh() {
            try {
                log('ğŸ”„ ë§Œë£Œëœ í† í°ìœ¼ë¡œ API í˜¸ì¶œ ì‹œë„ (ìë™ ê°±ì‹  í…ŒìŠ¤íŠ¸)...');
                
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${currentAccessToken || 'expired_token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    log('ğŸ”„ 401/403 ì—ëŸ¬ ë°œìƒ, Refresh Tokenìœ¼ë¡œ ê°±ì‹  ì‹œë„...', 'warning');
                    
                    try {
                        const refreshResponse = await fetch(`${API_BASE}/api/auth/refresh`, {
                            method: 'POST',
                            credentials: 'include'
                        });

                        if (refreshResponse.ok) {
                            const refreshData = await refreshResponse.json();
                            currentAccessToken = refreshData.accessToken;
                            localStorage.setItem('accessToken', currentAccessToken);
                            
                            log('âœ… ìƒˆë¡œìš´ Access Token ë°œê¸‰ë¨', 'success');
                            updateStatusDisplay();
                            
                            // ì›ë˜ ìš”ì²­ ì¬ì‹œë„
                            const retryResponse = await fetch(`${API_BASE}/api/auth/me`, {
                                headers: {
                                    'Authorization': `Bearer ${currentAccessToken}`,
                                    'Content-Type': 'application/json'
                                }
                            });

                            const retryData = await retryResponse.json();
                            
                            if (retryResponse.ok && retryData.success) {
                                document.getElementById('autoRefreshResult').innerHTML = `
                                    <div class="success">
                                        âœ… ìë™ ê°±ì‹  ì„±ê³µ!<br>
                                        ìƒˆ Access Token: ${currentAccessToken.substring(0, 50)}...<br>
                                        ì‚¬ìš©ì ì •ë³´: ${JSON.stringify(retryData.data.user, null, 2)}
                                    </div>
                                `;
                                log('âœ… ìë™ ê°±ì‹  í›„ API í˜¸ì¶œ ì„±ê³µ!', 'success');
                            } else {
                                document.getElementById('autoRefreshResult').innerHTML = `
                                    <div class="error">
                                        âŒ ê°±ì‹  í›„ API í˜¸ì¶œ ì‹¤íŒ¨: ${retryData.message}
                                    </div>
                                `;
                                log(`âŒ ê°±ì‹  í›„ API í˜¸ì¶œ ì‹¤íŒ¨: ${retryData.message}`, 'error');
                            }
                        } else {
                            document.getElementById('autoRefreshResult').innerHTML = `
                                <div class="error">
                                    âŒ Refresh Token ì‹¤íŒ¨: Refresh Tokenì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                                    ìë™ ë¡œê·¸ì•„ì›ƒì´ ë°œìƒí•´ì•¼ í•©ë‹ˆë‹¤.
                                </div>
                            `;
                            log('âŒ Refresh Token ì‹¤íŒ¨ - ìë™ ë¡œê·¸ì•„ì›ƒ ì˜ˆìƒ', 'error');
                            
                            // ìë™ ë¡œê·¸ì•„ì›ƒ í™•ì¸
                            setTimeout(() => {
                                checkStatus();
                            }, 1000);
                        }
                    } catch (refreshError) {
                        document.getElementById('autoRefreshResult').innerHTML = `
                            <div class="error">
                                âŒ Refresh Token ì˜¤ë¥˜: ${refreshError.message}
                            </div>
                        `;
                        log(`âŒ Refresh Token ì˜¤ë¥˜: ${refreshError.message}`, 'error');
                    }
                } else {
                    const data = await response.json();
                    document.getElementById('autoRefreshResult').innerHTML = `
                        <div class="success">
                            âœ… í† í°ì´ ì•„ì§ ìœ íš¨í•¨<br>
                            ì‚¬ìš©ì ì •ë³´: ${JSON.stringify(data.data.user, null, 2)}
                        </div>
                    `;
                    log('âœ… í† í°ì´ ì•„ì§ ìœ íš¨í•¨', 'success');
                }
            } catch (error) {
                document.getElementById('autoRefreshResult').innerHTML = `
                    <div class="error">
                        âŒ ì˜¤ë¥˜: ${error.message}
                    </div>
                `;
                log(`âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ìˆ˜ë™ ë¡œê·¸ì•„ì›ƒ
        async function manualLogout() {
            try {
                log('ğŸšª ìˆ˜ë™ ë¡œê·¸ì•„ì›ƒ ì‹œë„...');
                const response = await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('user');
                    currentAccessToken = null;
                    
                    log('âœ… ìˆ˜ë™ ë¡œê·¸ì•„ì›ƒ ì„±ê³µ', 'success');
                    updateStatusDisplay();
                } else {
                    log('âŒ ìˆ˜ë™ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                log(`âŒ ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ëª¨ë“  ë°ì´í„° ì •ë¦¬
        function clearAllData() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('user');
            currentAccessToken = null;
            
            log('ğŸ§¹ ëª¨ë“  ë°ì´í„° ì •ë¦¬ ì™„ë£Œ', 'success');
            updateStatusDisplay();
        }

        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // ìë™ ìƒíƒœ í™•ì¸ ì‹œì‘
        function startAutoCheck() {
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
            }
            
            autoCheckInterval = setInterval(() => {
                checkStatus();
                log('ğŸ”„ ìë™ ìƒíƒœ í™•ì¸ ì‹¤í–‰', 'info');
            }, 5000);
            
            log('âœ… ìë™ ìƒíƒœ í™•ì¸ ì‹œì‘ (5ì´ˆë§ˆë‹¤)', 'success');
        }

        // ìë™ ìƒíƒœ í™•ì¸ ì¤‘ì§€
        function stopAutoCheck() {
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
                autoCheckInterval = null;
                log('â¹ï¸ ìë™ ìƒíƒœ í™•ì¸ ì¤‘ì§€', 'warning');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            log('ğŸš€ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨');
            updateStatusDisplay();
            
            // íƒ€ì´ë¨¸ ì‹œì‘
            setInterval(updateTimer, 1000);
            
            // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ìƒíƒœ í™•ì¸
            window.addEventListener('focus', () => {
                log('ğŸ“± í˜ì´ì§€ í¬ì»¤ìŠ¤ë¨ - ìƒíƒœ í™•ì¸', 'info');
                checkStatus();
            });
        };

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            stopAutoCheck();
        });
    </script>
</body>
</html>
