<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자동 로그아웃 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .status-indicator { padding: 10px; border-radius: 5px; margin: 10px 0; font-weight: bold; }
        .status-logged-in { background-color: #d4edda; color: #155724; }
        .status-logged-out { background-color: #f8d7da; color: #721c24; }
        .timer { font-size: 1.2em; font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 자동 로그아웃 테스트 도구</h1>
        
        <div class="test-section info">
            <h3>📋 테스트 시나리오</h3>
            <ol>
                <li>로그인하여 토큰 발급</li>
                <li>토큰 상태 실시간 모니터링</li>
                <li>토큰 만료 시뮬레이션</li>
                <li>자동 로그아웃 확인</li>
                <li>브라우저 개발자 도구로 localStorage 변화 관찰</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>🔐 1. 로그인</h3>
            <input type="email" id="email" placeholder="이메일" value="test2@example.com">
            <input type="password" id="password" placeholder="비밀번호" value="password123">
            <button class="btn-primary" onclick="login()">로그인</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>📊 2. 현재 상태</h3>
            <div id="currentStatus" class="status-indicator status-logged-out">
                ❌ 로그아웃 상태
            </div>
            <button class="btn-info" onclick="checkStatus()">상태 확인</button>
            <button class="btn-warning" onclick="showTokens()">토큰 정보 보기</button>
        </div>

        <div class="test-section">
            <h3>⏰ 3. 토큰 만료 시뮬레이션</h3>
            <button class="btn-warning" onclick="simulateTokenExpiry()">Access Token 제거</button>
            <button class="btn-danger" onclick="simulateRefreshTokenExpiry()">Refresh Token 만료 시뮬레이션</button>
            <div id="expiryResult"></div>
        </div>

        <div class="test-section">
            <h3>🔄 4. 자동 갱신 테스트</h3>
            <button class="btn-success" onclick="testAutoRefresh()">자동 갱신 테스트</button>
            <div id="autoRefreshResult"></div>
        </div>

        <div class="test-section">
            <h3>🧹 5. 수동 정리</h3>
            <button class="btn-danger" onclick="manualLogout()">수동 로그아웃</button>
            <button class="btn-warning" onclick="clearAllData()">모든 데이터 정리</button>
        </div>

        <div class="test-section">
            <h3>📝 6. 실시간 로그</h3>
            <div id="testLog" class="log"></div>
            <button onclick="clearLog()">로그 지우기</button>
        </div>

        <div class="test-section">
            <h3>⏱️ 7. 자동 상태 확인 타이머</h3>
            <div class="timer" id="timer">00:00</div>
            <button class="btn-success" onclick="startAutoCheck()">자동 확인 시작</button>
            <button class="btn-warning" onclick="stopAutoCheck()">자동 확인 중지</button>
            <p>5초마다 토큰 상태를 자동으로 확인합니다.</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        let currentAccessToken = null;
        let autoCheckInterval = null;
        let startTime = Date.now();

        // 로그 함수
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('testLog');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'blue';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 타이머 업데이트
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 상태 표시 업데이트
        function updateStatusDisplay() {
            const statusDiv = document.getElementById('currentStatus');
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                statusDiv.className = 'status-indicator status-logged-in';
                statusDiv.innerHTML = '✅ 로그인 상태';
            } else {
                statusDiv.className = 'status-indicator status-logged-out';
                statusDiv.innerHTML = '❌ 로그아웃 상태';
            }
        }

        // 로그인
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                log('🔐 로그인 시도...');
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    currentAccessToken = data.data.accessToken;
                    localStorage.setItem('accessToken', currentAccessToken);
                    localStorage.setItem('user', JSON.stringify(data.data.user));
                    
                    document.getElementById('loginResult').innerHTML = `
                        <div class="success">
                            ✅ 로그인 성공!<br>
                            사용자: ${data.data.user.name}<br>
                            Access Token: ${currentAccessToken.substring(0, 50)}...<br>
                            Refresh Token: 쿠키에 설정됨
                        </div>
                    `;
                    log('✅ 로그인 성공', 'success');
                    updateStatusDisplay();
                } else {
                    document.getElementById('loginResult').innerHTML = `
                        <div class="error">
                            ❌ 로그인 실패: ${data.message}
                        </div>
                    `;
                    log(`❌ 로그인 실패: ${data.message}`, 'error');
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = `
                    <div class="error">
                        ❌ 오류: ${error.message}
                    </div>
                `;
                log(`❌ 오류: ${error.message}`, 'error');
            }
        }

        // 상태 확인
        function checkStatus() {
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                const userData = JSON.parse(user);
                log(`✅ 토큰 존재 - 사용자: ${userData.name}`, 'success');
            } else {
                log('❌ 토큰이 없음', 'error');
            }
            updateStatusDisplay();
        }

        // 토큰 정보 보기
        function showTokens() {
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                const userData = JSON.parse(user);
                log(`🔑 Access Token: ${token.substring(0, 50)}...`, 'info');
                log(`👤 사용자: ${userData.name} (${userData.email})`, 'info');
                log(`📅 생성 시간: ${new Date().toLocaleString()}`, 'info');
            } else {
                log('❌ 저장된 토큰 정보가 없습니다', 'error');
            }
        }

        // 토큰 만료 시뮬레이션
        function simulateTokenExpiry() {
            localStorage.removeItem('accessToken');
            currentAccessToken = null;
            
            document.getElementById('expiryResult').innerHTML = `
                <div class="warning">
                    ⚠️ Access Token을 제거했습니다 (만료 시뮬레이션)<br>
                    이제 보호된 API를 호출하면 401 에러가 발생해야 합니다.
                </div>
            `;
            log('⚠️ Access Token 제거됨 (만료 시뮬레이션)', 'warning');
            updateStatusDisplay();
        }

        // Refresh Token 만료 시뮬레이션
        function simulateRefreshTokenExpiry() {
            // 쿠키를 직접 삭제할 수는 없지만, 만료된 것처럼 시뮬레이션
            log('⚠️ Refresh Token 만료 시뮬레이션 (쿠키는 브라우저에서 수동으로 삭제해야 함)', 'warning');
            document.getElementById('expiryResult').innerHTML = `
                <div class="warning">
                    ⚠️ Refresh Token 만료 시뮬레이션<br>
                    브라우저 개발자 도구 → Application → Cookies에서 refreshToken을 수동으로 삭제하세요.
                </div>
            `;
        }

        // 자동 갱신 테스트
        async function testAutoRefresh() {
            try {
                log('🔄 만료된 토큰으로 API 호출 시도 (자동 갱신 테스트)...');
                
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${currentAccessToken || 'expired_token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    log('🔄 401/403 에러 발생, Refresh Token으로 갱신 시도...', 'warning');
                    
                    try {
                        const refreshResponse = await fetch(`${API_BASE}/api/auth/refresh`, {
                            method: 'POST',
                            credentials: 'include'
                        });

                        if (refreshResponse.ok) {
                            const refreshData = await refreshResponse.json();
                            currentAccessToken = refreshData.accessToken;
                            localStorage.setItem('accessToken', currentAccessToken);
                            
                            log('✅ 새로운 Access Token 발급됨', 'success');
                            updateStatusDisplay();
                            
                            // 원래 요청 재시도
                            const retryResponse = await fetch(`${API_BASE}/api/auth/me`, {
                                headers: {
                                    'Authorization': `Bearer ${currentAccessToken}`,
                                    'Content-Type': 'application/json'
                                }
                            });

                            const retryData = await retryResponse.json();
                            
                            if (retryResponse.ok && retryData.success) {
                                document.getElementById('autoRefreshResult').innerHTML = `
                                    <div class="success">
                                        ✅ 자동 갱신 성공!<br>
                                        새 Access Token: ${currentAccessToken.substring(0, 50)}...<br>
                                        사용자 정보: ${JSON.stringify(retryData.data.user, null, 2)}
                                    </div>
                                `;
                                log('✅ 자동 갱신 후 API 호출 성공!', 'success');
                            } else {
                                document.getElementById('autoRefreshResult').innerHTML = `
                                    <div class="error">
                                        ❌ 갱신 후 API 호출 실패: ${retryData.message}
                                    </div>
                                `;
                                log(`❌ 갱신 후 API 호출 실패: ${retryData.message}`, 'error');
                            }
                        } else {
                            document.getElementById('autoRefreshResult').innerHTML = `
                                <div class="error">
                                    ❌ Refresh Token 실패: Refresh Token이 만료되었습니다.<br>
                                    자동 로그아웃이 발생해야 합니다.
                                </div>
                            `;
                            log('❌ Refresh Token 실패 - 자동 로그아웃 예상', 'error');
                            
                            // 자동 로그아웃 확인
                            setTimeout(() => {
                                checkStatus();
                            }, 1000);
                        }
                    } catch (refreshError) {
                        document.getElementById('autoRefreshResult').innerHTML = `
                            <div class="error">
                                ❌ Refresh Token 오류: ${refreshError.message}
                            </div>
                        `;
                        log(`❌ Refresh Token 오류: ${refreshError.message}`, 'error');
                    }
                } else {
                    const data = await response.json();
                    document.getElementById('autoRefreshResult').innerHTML = `
                        <div class="success">
                            ✅ 토큰이 아직 유효함<br>
                            사용자 정보: ${JSON.stringify(data.data.user, null, 2)}
                        </div>
                    `;
                    log('✅ 토큰이 아직 유효함', 'success');
                }
            } catch (error) {
                document.getElementById('autoRefreshResult').innerHTML = `
                    <div class="error">
                        ❌ 오류: ${error.message}
                    </div>
                `;
                log(`❌ 오류: ${error.message}`, 'error');
            }
        }

        // 수동 로그아웃
        async function manualLogout() {
            try {
                log('🚪 수동 로그아웃 시도...');
                const response = await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('user');
                    currentAccessToken = null;
                    
                    log('✅ 수동 로그아웃 성공', 'success');
                    updateStatusDisplay();
                } else {
                    log('❌ 수동 로그아웃 실패', 'error');
                }
            } catch (error) {
                log(`❌ 로그아웃 오류: ${error.message}`, 'error');
            }
        }

        // 모든 데이터 정리
        function clearAllData() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('user');
            currentAccessToken = null;
            
            log('🧹 모든 데이터 정리 완료', 'success');
            updateStatusDisplay();
        }

        // 로그 지우기
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // 자동 상태 확인 시작
        function startAutoCheck() {
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
            }
            
            autoCheckInterval = setInterval(() => {
                checkStatus();
                log('🔄 자동 상태 확인 실행', 'info');
            }, 5000);
            
            log('✅ 자동 상태 확인 시작 (5초마다)', 'success');
        }

        // 자동 상태 확인 중지
        function stopAutoCheck() {
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
                autoCheckInterval = null;
                log('⏹️ 자동 상태 확인 중지', 'warning');
            }
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            log('🚀 테스트 페이지 로드됨');
            updateStatusDisplay();
            
            // 타이머 시작
            setInterval(updateTimer, 1000);
            
            // 페이지 포커스 시 상태 확인
            window.addEventListener('focus', () => {
                log('📱 페이지 포커스됨 - 상태 확인', 'info');
                checkStatus();
            });
        };

        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', () => {
            stopAutoCheck();
        });
    </script>
</body>
</html>
